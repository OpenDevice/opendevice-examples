var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={DIGITAL:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,PWM:6,INFRA_RED:7,DEVICE_COMMAND_RESPONSE:10,PING:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,USER_COMMAND:99,isDeviceCommand:function(g){switch(g){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.Event={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_CHANGED:"DEVICE_CHANGED",CONNECTION_CHANGE:"CONNECTION_CHANGE",CONNECTED:"CONNECTION_CHANGE_CONNECTED",DISCONNECTED:"CONNECTION_CHANGE_DISCONNECTED"};od=od||{};
od.Device=function(g){this.id=g.id;this.name=g.name;this.type=g.type;this.category=g.category;this.value=g.value;this.sensor=g.sensor;this.manager=od.deviceManager;this.on=function(){this.setValue(1)};this.off=function(){this.setValue(0)};this.isON=function(){return 1==value};this.isOFF=function(){return 0==value};this.setValue=function(a){this.value=a;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=this.toggle=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)}};
od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(g){function a(a){for(var d=0;d<e.length;d++){var h=e[d].connectionStateChanged;"function"===typeof h&&h(f,a,f.status)}f.status=a}var f=this,b=od.ConnectionStatus,l=window.atmosphere||$.atmosphere,k,e=[];od.connection=this;this.status=b.DISCONNECTED;this.config=g;(function(c){void 0==c.contentType&&(c.contentType="application/json");void 0==c.transport&&(c.transport="websocket");void 0==c.fallbackTransport&&(c.fallbackTransport="long-polling");void 0==c.reconnectInterval&&
(c.reconnectInterval=5E3);void 0==c.maxReconnectOnClose&&(c.maxReconnectOnClose=5);c.onError=function(d){console.log("Connection.onError");a(b.FAIL)};c.onMessage=function(d){var h=null;try{h=JSON.parse(d.responseBody)}catch(a){console.warn("Can't parse response: "+d.responseBody,a.stack)}if(h)for(console.log("Connection.onMessageReceived(from:"+d.request.uuid+") -\x3e "+d.responseBody),d=h,h=0;h<e.length;h++){var b=e[h].onMessageReceived;"function"===typeof b&&b(f,d)}};c.onMessagePublished=function(d){console.log("Connection.onMessagePublished")};
c.onClose=function(d){console.log("Connection.onClose");a(b.DISCONNECTED)};c.onOpen=function(d){console.log("Connection.onOpen");a(b.CONNECTED)};c.onReopen=function(d){console.log("Connection.onReopen");a(b.CONNECTED)};c.onReconnect=function(d){console.log("Connection.onReconnect");a(b.CONNECTING)};c.onTransportFailure=function(d){console.log("Connection.onTransportFailure");a(b.FAIL)};c.onFailureToReconnect=function(d){console.log("Connection.onFailureToReconnect");a(b.DISCONNECTED)};c.onClientTimeout=
function(d){console.log("Connection.onClientTimeout");a(b.FAIL)}})(g);this.connect=function(){f.config.url=f.getUrl();console.log("Connection to: "+f.config.url);k=l.subscribe(f.config);a(b.CONNECTING);return f};this.getUrl=function(){return od.serverURL+"/device/connection/"+od.appID};this.send=function(a){k.push(JSON.stringify(a))};this.addListener=function(a){e.push(a)};this.isConnected=function(){return f.status=b.CONNECTED};this.getConnectionUUID=function(){return k.getUUID()}};od=od||{};
od.deviceManager={};
od.DeviceManager=function(g){function a(d,h){if(void 0!==c[d])for(var a=c[d],b=0;b<a.length;b++)if("function"===typeof a[b])try{a[b](h)}catch(f){console.log(f)}}function f(){for(var d=OpenDevice.devices.list(),a=[],b=0;b<d.length;b++)a.push(new od.Device(d[b]));return a}var b=this;od.deviceManager=this;var l=od.Event,k=od.CommandType,e=[],c={};this.connection=g||od.connection;this.setValue=function(d,h){b.connection.send({type:k.DIGITAL,deviceID:d,value:h});var f=b.findDevice(d);f&&(f.value=h,a(l.DEVICE_CHANGED,
f))};this.toggleValue=function(d){(d=b.findDevice(d))&&!d.sensor&&d.toggleValue()};this.send=function(d){b.connection.send(d)};this.addDevice=function(){};this.getDevices=function(){return e&&0<e.length?e:e=this.sync(!1)};this.findDevice=function(d){if(e)for(var a=0;a<e.length;a++){if(e[a].id==d)return e[a]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(d,h){e=null;e=f();(h||e&&0==e.length)&&b.send({type:k.GET_DEVICES,forceSync:h});!0===d&&a(l.DEVICE_LIST_UPDATE,
e);return e};this.on=function(a,h){b.addListener(a,h)};this.onDeviceChange=function(a){b.addListener(od.Event.DEVICE_CHANGED,a)};this.onConnect=function(a){this.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();a&&a(b)})};this.addListener=function(a,b){void 0===c[a]&&(c[a]=[]);c[a].push(b)};this.contains=function(a,f){null==f&&(f=b.getDevices());for(var c=0;c<f.length;c++)if("object"==typeof f[c]){if(a.id==f[c].id)return!0}else if(a.id==f[c])return!0;return!1};b.connection.addListener({onMessageReceived:function(d,
c){if(!k.isDeviceCommand(c.type)||d.getConnectionUUID()!=c.connectionUUID){if(k.isDeviceCommand(c.type)){console.log("Device changed in another client..");var e=b.findDevice(c.deviceID);e&&(e.value=c.value);e&&a(l.DEVICE_CHANGED,e)}c.type==k.GET_DEVICES_RESPONSE&&(e=f(),a(l.DEVICE_LIST_UPDATE,e))}},connectionStateChanged:function(f,c,e){console.log("DeviceManager._connectionStateChanged :"+c);a(l.CONNECTION_CHANGE,c);od.ConnectionStatus.CONNECTED==c&&a(l.CONNECTED,b.getDevices());od.ConnectionStatus.CONNECTED==
c&&a(l.DISCONNECTED)}})};od=od||{};od.APP_ID_NAME="AppID";od.version="1.0";od.appID="*";od.serverURL="http://"+window.location.host;
var OpenDevice=function(){var g=new od.DeviceConnection({logLevel:"debug"}),a=new od.DeviceManager(g);return{appID:od.appID,serverURL:od.serverURL,manager:a,on:a.on,onDeviceChange:a.onDeviceChange,onChange:a.onDeviceChange,onConnect:a.onConnect,findDevice:a.findDevice,getDevices:a.getDevices,setValue:a.setValue,toggleValue:a.toggleValue,contains:a.contains,sync:a.sync,send:a.send,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){a&&(g=a);g.connect()},rest:function(a){a=
$.ajax({type:"GET",url:od.serverURL+a,headers:{"X-AppID":od.appID},async:!1}).responseText;return 0<a.length?JSON.parse(a):null},history:function(a,b){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json","X-AppID":od.appID},type:"POST",url:od.serverURL+"/device/"+a.deviceID+"/history",data:JSON.stringify(a),dataType:"json",async:!0,success:b})},findAppID:function(){od.appID=function(a){var b;b=window.location.search.substr(1).split("\x26");if(""==b)b={};else{for(var g=
{},k=0;k<b.length;++k){var e=b[k].split("\x3d",2);g[e[0]]=1==e.length?"":decodeURIComponent(e[1].replace(/\+/g," "))}b=g}return b[a]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/device",get:function(g){return OpenDevice.rest(OpenDevice.devices.path+"/"+g)},value:function(g,a){return null!=a?OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value/"+a):OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value")},list:function(){return OpenDevice.rest(OpenDevice.devices.path+"/list")},sync:function(){return OpenDevice.rest(OpenDevice.devices.path+"/sync")}};