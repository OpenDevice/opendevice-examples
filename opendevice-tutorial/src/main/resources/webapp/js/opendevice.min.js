var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={DIGITAL:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,PWM:6,INFRA_RED:7,DEVICE_COMMAND_RESPONSE:10,PING:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,USER_COMMAND:99,isDeviceCommand:function(g){switch(g){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.Event={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_CHANGED:"DEVICE_CHANGED",CONNECTION_CHANGE:"CONNECTION_CHANGE",CONNECTED:"CONNECTION_CHANGE_CONNECTED",DISCONNECTED:"CONNECTION_CHANGE_DISCONNECTED"};od=od||{};
od.Device=function(g){this.id=g.id;this.name=g.name;this.type=g.type;this.category=g.category;this.value=g.value;this.sensor=g.sensor;this.manager=od.deviceManager;this.setValue=function(d){this.value=d;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=function(){var d=0;0==this.value?d=1:1==this.value&&(d=0);this.setValue(d)}};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(g){function d(c){for(var e=0;e<f.length;e++){var h=f[e].connectionStateChanged;"function"===typeof h&&h(a,c,a.status)}a.status=c}var a=this,b=od.ConnectionStatus,k=window.atmosphere||$.atmosphere,l,f=[];od.connection=this;this.status=b.DISCONNECTED;this.config=g;(function(c){void 0==c.contentType&&(c.contentType="application/json");void 0==c.transport&&(c.transport="websocket");void 0==c.fallbackTransport&&(c.fallbackTransport="long-polling");void 0==c.reconnectInterval&&
(c.reconnectInterval=5E3);void 0==c.maxReconnectOnClose&&(c.maxReconnectOnClose=5);c.onError=function(e){console.log("Connection.onError");d(b.FAIL)};c.onMessage=function(e){var h=null;try{h=JSON.parse(e.responseBody)}catch(c){console.error("Can't parse response. Error: "+c)}if(h)for(console.log("Connection.onMessageReceived(from:"+e.request.uuid+") -\x3e "+e.responseBody),e=h,h=0;h<f.length;h++){var b=f[h].onMessageReceived;"function"===typeof b&&b(a,e)}};c.onMessagePublished=function(e){console.log("Connection.onMessagePublished")};
c.onClose=function(e){console.log("Connection.onClose");d(b.DISCONNECTED)};c.onOpen=function(e){console.log("Connection.onOpen");d(b.CONNECTED)};c.onReopen=function(e){console.log("Connection.onReopen");d(b.CONNECTED)};c.onReconnect=function(e){console.log("Connection.onReconnect");d(b.CONNECTING)};c.onTransportFailure=function(e){console.log("Connection.onTransportFailure");d(b.FAIL)};c.onFailureToReconnect=function(e){console.log("Connection.onFailureToReconnect");d(b.DISCONNECTED)};c.onClientTimeout=
function(e){console.log("Connection.onClientTimeout");d(b.FAIL)}})(g);this.connect=function(){a.config.url=a.getUrl();console.log("Connection to: "+a.config.url);l=k.subscribe(a.config);d(b.CONNECTING);return a};this.getUrl=function(){return od.serverURL+"/device/connection/"+od.appID};this.send=function(a){l.push(JSON.stringify(a))};this.addListener=function(a){f.push(a)};this.isConnected=function(){return a.status=b.CONNECTED};this.getConnectionUUID=function(){return l.getUUID()}};od=od||{};
od.deviceManager={};
od.DeviceManager=function(g){function d(e){f=null;for(var h=OpenDevice.devices.list(),b=[],c=0;c<h.length;c++)b.push(new od.Device(h[c]));f=b;!0===e&&a(k.DEVICE_LIST_UPDATE,f);return f}function a(e,h){if(void 0!==c[e])for(var a=c[e],b=0;b<a.length;b++)if("function"===typeof a[b])try{a[b](h)}catch(d){console.log(d)}}var b=this;od.deviceManager=this;var k=od.Event,l=od.CommandType,f=[],c={};this.connection=g||od.connection;this.setValue=function(e,h){b.connection.send({type:l.DIGITAL,deviceID:e,value:h});
var c=b.findDevice(e);c&&(c.value=h,a(k.DEVICE_CHANGED,c))};this.toggleValue=function(e){(e=b.findDevice(e))&&!e.sensor&&e.toggleValue()};this.addDevice=function(){};this.getDevices=function(){return f&&0<f.length?f:f=d(!1)};this.findDevice=function(e){if(f)for(var a=0;a<f.length;a++){if(f[a].id==e)return f[a]}else console.warn("Devices not loaded or empty !");return null};this.on=function(a,h){b.addListener(a,h)};this.onDeviceChange=function(a){b.addListener(od.Event.DEVICE_CHANGED,a)};this.addListener=
function(a,b){void 0===c[a]&&(c[a]=[]);c[a].push(b)};this.contains=function(a,c){null==c&&(c=b.getDevices());for(var d=0;d<c.length;d++)if("object"==typeof c[d]){if(a.id==c[d].id)return!0}else if(a.id==c[d])return!0;return!1};b.connection.addListener({onMessageReceived:function(c,d){if((!l.isDeviceCommand(d.type)||c.getConnectionUUID()!=d.connectionUUID)&&l.isDeviceCommand(d.type)){console.log("Device changed in another client..");var f=b.findDevice(d.deviceID);f&&(f.value=d.value);f&&a(k.DEVICE_CHANGED,
f)}},connectionStateChanged:function(c,b,f){console.log("DeviceManager._connectionStateChanged :"+b);a(k.CONNECTION_CHANGE,b);od.ConnectionStatus.CONNECTED==b&&(d(!0),a(k.CONNECTED));od.ConnectionStatus.CONNECTED==b&&a(k.DISCONNECTED)}})};od=od||{};od.APP_ID_NAME="AppID";od.version="1.0";od.appID="*";od.serverURL="http://"+window.location.host;
var OpenDevice=function(){var g=new od.DeviceConnection({logLevel:"debug"}),d=new od.DeviceManager(g);return{appID:od.appID,serverURL:od.serverURL,manager:d,on:d.on,onDeviceChange:d.onDeviceChange,findDevice:d.findDevice,getDevices:d.getDevices,setValue:d.setValue,toggleValue:d.toggleValue,contains:d.contains,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){OpenDevice.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();a&&a(b)});g.connect()},rest:function(a){a=
$.ajax({type:"GET",url:od.serverURL+a,headers:{"X-AppID":od.appID},async:!1}).responseText;return JSON.parse(a)},history:function(a,b){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json","X-AppID":od.appID},type:"POST",url:od.serverURL+"/device/"+a.deviceID+"/history",data:JSON.stringify(a),dataType:"json",async:!0,success:b})},findAppID:function(){od.appID=function(a){var b;b=window.location.search.substr(1).split("\x26");if(""==b)b={};else{for(var d={},g=0;g<b.length;++g){var f=
b[g].split("\x3d",2);d[f[0]]=1==f.length?"":decodeURIComponent(f[1].replace(/\+/g," "))}b=d}return b[a]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}();
OpenDevice.devices={path:"/device",get:function(g){return OpenDevice.rest(OpenDevice.devices.path+"/"+g)},value:function(g,d){return null!=d?OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value/"+d):OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value")},list:function(g){return OpenDevice.rest(OpenDevice.devices.path+"/list")}};